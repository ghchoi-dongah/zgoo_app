<html layout:decorate="~{fragments/layout}">
<div layout:fragment="content" class="h-100">
    <div class="search-container">
        <!-- filter -->
        <span class="filter" id="filter"><i class="bi bi-filter-circle-fill"></i></span>
        <!-- 검색창 -->
        <span class="search-content" id="searchContainer">
            <div class="search-box" id="searchBox">충전소, 장소 검색</div>
            <span class="icon"><i class="bi bi-search"></i></span>
        </span>
        <!-- route -->
        <span id="route" class="route"><i class="fa-solid fa-diamond-turn-right"></i></span>
        <!-- location -->
        <span class="location"><i class="fa-solid fa-location-crosshairs"></i></span>
    </div>


    <div class="w-100 h-100" id="map"></div>

    <div th:replace="~{fragments/nav :: navFragment}"></div>

    <div id="stationDetail" class="station-detail" style="display: none;">
        <div id="slidebar" class="slidebar"></div>
        <div class="station-content">
            <div>
                <p class="font-m ps-4 position-relative">
                    <i id="favStar" class="bi bi-star" style="position: absolute; top: 0; left: 0;" role="button" aria-label="즐겨찾기"></i>
                    <span id="stationName"></span>
                    <input id="stationId" hidden>
                </p>
                <p class="font-s ps-4"></p><hr>
            </div>
            <div id="stationContainer" class="row row-cols-w font-s">
                <div class="col-4 mb-2">주소</div>
                <div class="col-8" id="address"></div>
                <div class="col-4  mb-2">상세주소</div>
                <div class="col-8" id="addressDetail"></div>
                <div class="col-4  mb-2">운영상태</div>
                <div class="col-8" id="opStatus"></div>
                <div class="col-4  mb-2">운영시간</div>
                <div class="col-8" id="opTime"></div>
                <div class="col-4  mb-2">주차요금</div>
                <div class="col-8" id="parkingFee"></div>
            </div>
        </div>
    </div>

    <div id="filterSetting" class="top-layer">
        <div class="container">
            <div class="mem-header">
                <span onclick="closeAlert('filterSetting')"><i class="fa-solid fa-chevron-left"></i></span>
                <span>필터설정</span>
            </div>
            <div class="mem-body p-2">
                <div class="filter-op mb-4" data-group="speed">
                    <p>충전 속도</p>
                    <span class="font-m" data-value="7"><i class="bi bi-lightning-charge"></i>7kw</span>
                    <span class="font-m" data-value="50"><i class="bi bi-lightning-charge"></i>50kw</span>
                    <span class="font-m" data-value="100"><i class="bi bi-lightning-charge"></i>100kw</span>
                </div>
                <div class="filter-op mb-4" data-group="conType">
                    <p>충전기 타입</p>
                    <span th:each="data : ${conTypeList}" th:text="${data.commonCodeName}" th:id="${data.commonCode}" class="font-m"></span>
                </div>
                <div class="filter-op mb-4" data-group="sub">
                    <p>충전소시설구분</p>
                    <span th:each="data : ${subList}" th:text="${data.commonCodeName}" th:id="${data.commonCode}" class="font-m"></span>
                </div>
                <div class="filter-op mb-4" data-group="fac">
                    <p>충전소시설유형</p>
                    <span th:each="data : ${facList}" th:text="${data.commonCodeName}" th:id="${data.commonCode}" class="font-m"></span>
                </div>
                <div class="filter-op mb-4" data-group="access">
                    <p>접근</p>
                    <span class="font-m" data-value="open">개방</span>
                    <span class="font-m" data-value="closed">비개방</span>
                </div>
            </div>
            <div class="btn-display-flex">
                <button class="btn btn-reset">초기화</button>
                <button class="btn btn-apply">적용</button>
            </div>
        </div>
    </div>

    <div id="searchSetting" class="top-layer">
        <div class="container">
            <div class="mem-header">
                <span onclick="closeAlert('searchSetting')"><i class="fa-solid fa-chevron-left"></i></span>
                <span>검색</span>
            </div>
            <div class="mem-body p-2">
                <div class="station-search mb-5">
                    <input type="text" id="csSearch" autocomplete="off"/>
                    <span ><i class="bi bi-search"></i></span>
                </div>
                <div class="font-m">
                    <span class="me-3 text-focus" id="STATION">충전소</span>
                    <span id="ADDRESS">주소</span>
                </div>
                <div id="searchResult" class="font-m">
                    <div class="csinfo-n">
                        <i class="bi bi-search"></i>
                        <span>검색 내역이 없습니다.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2627a1d15418d5bd6f92dfadded8a675&libraries=services,clusterer"></script>
    <script type="text/javascript" th:src="@{/js/map.js}"></script>

    <script>
        (() => {
        const CACHE_KEY = 'chargerFilterCache';

        // 유틸
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // 값 추출: data-value > id > textContent(라벨)
        const getOptionValue = (el) => el.dataset.value || el.id || el.textContent.trim();
        const getOptionLabel = (el) => el.textContent.trim();

        // 현재 선택 상태 → { [group]: [{value, label}, ...] }
        const collectSelected = () => {
            const result = {};
            $$('.filter-op').forEach(groupEl => {
            const group = groupEl.dataset.group;
            const selectedEls = $$('.font-m.selected', groupEl);
            if (selectedEls.length) {
                result[group] = selectedEls.map(el => ({
                value: getOptionValue(el),
                label: getOptionLabel(el),
                }));
            }
            });
            return result;
        };

        // 캐시 저장/로드/삭제
        const saveCache = (data) => localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        const loadCache = () => {
            try {
            const raw = localStorage.getItem(CACHE_KEY);
            return raw ? JSON.parse(raw) : {};
            } catch (e) {
            console.warn('필터 캐시 파싱 실패:', e);
            return {};
            }
        };
        const clearCache = () => localStorage.removeItem(CACHE_KEY);

        // 캐시 기반으로 UI에 selected 복원
        const applyCacheToUI = (cache) => {
            // 모두 초기화 후 적용
            $$('.filter-op .font-m').forEach(el => el.classList.remove('selected'));
            Object.entries(cache).forEach(([group, items]) => {
            const groupEl = $(`.filter-op[data-group="${group}"]`);
            if (!groupEl) return;
            const options = $$('.font-m', groupEl);
            items.forEach(({value}) => {
                // 동일 값 매칭: data-value or id or text
                const match = options.find(el =>
                (el.dataset.value && el.dataset.value == value) ||
                (el.id && el.id == value) ||
                el.textContent.trim() == value
                );
                if (match) match.classList.add('selected');
            });
            });
        };

        // 이벤트 바인딩
        const bindEvents = () => {
            // 옵션 토글(이벤트 위임)
            $$('.filter-op').forEach(groupEl => {
            groupEl.addEventListener('click', (e) => {
                const target = e.target.closest('.font-m');
                if (!target) return;
                target.classList.toggle('selected');
            });
            });

            // 초기화 버튼
            $('.btn.btn-reset')?.addEventListener('click', () => {
            $$('.filter-op .font-m').forEach(el => el.classList.remove('selected'));
            // 필요 시 캐시도 비울 거면 다음 줄 활성화
            // clearCache();
            });

            // 적용 버튼: 선택값을 그룹별로 캐시에 저장
            $('.btn.btn-apply')?.addEventListener('click', () => {
            const data = collectSelected();
            saveCache(data);
            // 필요하면 토스트/알림
            console.log('필터가 저장되었습니다:', data);
            });
        };

        // 디버그/확인용: 전역 헬퍼 노출
        window.FilterCache = {
            get: loadCache,
            set: saveCache,
            clear: clearCache,
            applyToUI: applyCacheToUI,
            collectSelected
        };

        // 초기 로드 시 캐시 복원
        document.addEventListener('DOMContentLoaded', () => {
            bindEvents();
            const cached = loadCache();
            if (cached && Object.keys(cached).length) {
            applyCacheToUI(cached);
            }
        });
        })();

        document.getElementById('filter').addEventListener('click', function () {
            const CACHE_KEY = 'chargerFilterCache';

            // 유틸
            const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
            const $ = (sel, root=document) => root.querySelector(sel);

            const getOptionValue = (el) => el.dataset.value || el.id || el.textContent.trim();

            // 캐시 불러오기
            const loadCache = () => {
                try {
                const raw = localStorage.getItem(CACHE_KEY);
                return raw ? JSON.parse(raw) : {};
                } catch (e) {
                console.warn('캐시 파싱 실패:', e);
                return {};
                }
            };

            // UI 반영
            const applyCacheToUI = (cache) => {
                // 전체 옵션 selected 제거
                $$('.filter-op .font-m').forEach(el => el.classList.remove('selected'));

                // 캐시된 값만 다시 selected 부여
                Object.entries(cache).forEach(([group, items]) => {
                const groupEl = $(`.filter-op[data-group="${group}"]`);
                if (!groupEl) return;
                const options = $$('.font-m', groupEl);

                items.forEach(({value}) => {
                    const match = options.find(el =>
                    (el.dataset.value && el.dataset.value == value) ||
                    (el.id && el.id == value) ||
                    el.textContent.trim() == value
                    );
                    if (match) match.classList.add('selected');
                });
                });
            };

            const cachedData = loadCache();
            applyCacheToUI(cachedData);
            document.getElementById('filterSetting').style.display = 'block';
        });
    </script>
</div>
</html>