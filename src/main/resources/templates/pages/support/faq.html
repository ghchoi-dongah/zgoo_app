<html layout:decorate="~{fragments/layout}">
<div layout:fragment="content" class="container">
    <div class="mem-header">
        <span onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></span>
        <span>자주하는 질문</span>
    </div>
    <div class="p-2" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div class="filter-content font-s">
            <span id="ALL" class="filter-focus section" onclick="handleFilterClick(this)">전체</span>
            <span th:each="type : ${typeList}" th:text="${type.commonCodeName}" th:id="${type.commonCode}"
                th:class="section" onclick="handleFilterClick(this)"></span>
        </div>

        <div class="accordion accordion-flush font-m" id="accordionFlush" style="border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
            <div class="accordion-item" th:each="faq : ${faqList}">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="|#${faq.faqId}|"
                        aria-expanded="false" th:aria-controls="${faq.faqId}" th:text="|Q. ${faq.title}|">
                    </button>
                </h2>
                <div th:id="${faq.faqId}" class="accordion-collapse collapse" data-bs-parent="#accordionFlush">
                    <div class="accordion-body" th:text="${faq.content}"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function handleFilterClick(clickedSpan) {
            const spans = document.querySelectorAll("span.section");
            spans.forEach(span => span.classList.remove("filter-focus"));

            // 클릭한 span에만 filter-focus 클래스 추가
            clickedSpan.classList.add("filter-focus");
            console.log("Clicked span id:", clickedSpan.id);

            findFilterFaq(clickedSpan.id);
        }

        function findFilterFaq(section) {
            fetch(`/faq/get?section=${encodeURIComponent(section)}`, {
                method: 'GET',
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Network Error: ' + response.status);
                    }
                    return response.json();
                })
                .then((data) => {
                    const accordionFlush = document.getElementById('accordionFlush');
                    accordionFlush.innerHTML = '';

                    if (!data || data.length === 0) {
                        const noData = document.createElement('div');
                        noData.textContent = '등록된 게시물이 없습니다.';
                        noData.className = 'px-2 py-3';
                        accordionFlush.appendChild(noData);
                        return;
                    }

                    data.forEach((faq) => {
                        const accordionItem = document.createElement('div');
                        accordionItem.className = 'accordion-item';

                        // header 생성
                        const header = document.createElement('h2');
                        header.className = 'accordion-header';

                        const button = document.createElement('button');
                        button.className = 'accordion-button collapsed';
                        button.type = 'button';
                        button.setAttribute('data-bs-toggle', 'collapse');
                        button.setAttribute('data-bs-target', `#${faq.faqId}`);
                        button.setAttribute('aria-expanded', 'false');
                        button.setAttribute('aria-controls', faq.faqId);
                        button.textContent = `Q. ${faq.title}`;

                        header.appendChild(button);
                        accordionItem.appendChild(header);

                        // collapse 영역 생성
                        const collapse = document.createElement('div');
                        collapse.className = 'accordion-collapse collapse';
                        collapse.id = faq.faqId;
                        collapse.setAttribute('data-bs-parent', '#accordionFlush');

                        const body = document.createElement('div');
                        body.className = 'accordion-body';
                        body.textContent = faq.content;

                        collapse.appendChild(body);
                        accordionItem.appendChild(collapse);

                        // 최종적으로 accordion에 추가
                        accordionFlush.appendChild(accordionItem);
                    });
                })
                .catch((error) => {
                    console.error('에러: ', error);
                });
        }
    </script>
</div>
</html>