<html layout:decorate="~{fragments/layout}">
<div layout:fragment="content" class="main-content">
    <div th:replace="~{fragments/header :: headerFragment}"></div>

    <div id="loginGuide" class="position-relative w-100 mt-5" sec:authorize="isAnonymous()">
        <div class="fw-bold">로그인 하시면</div>
        <span class="span-bw-r font-s" style="position: absolute; right: 0; top: 0;">
            <a th:href="@{/login}">로그인</a>
        </span>
        <div class="mt-2">다양한 서비스를 이용하실 수 있어요!</div>
    </div>
    <div id="carouselExampleIndicators" class="carousel slide mt-3" style="height: 35%; background-color: grey;" sec:authorize="isAnonymous()">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <!-- <img src="..." class="d-block w-100" alt="..."> -->
                <div style="width: 100%; height: 100%; background-color: aquamarine;"></div>
            </div>
            <div class="carousel-item">
                <!-- <img src="..." class="d-block w-100" alt="..."> -->
                <div style="width: 100%; height: 100%; background-color: grey;"></div>
            </div>
            <div class="carousel-item">
                <!-- <img src="..." class="d-block w-100" alt="..."> -->
                <div style="width: 100%; height: 100%; background-color: rebeccapurple;"></div>
            </div>
        </div>
        <!-- <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button> -->
    </div>

    <!-- 충전이력, 충전현황, QR -->
    <div class="home-btn-container" sec:authorize="isAuthenticated()">
        <div class="box charge-history" onclick="goPage('/mypage/history/charge')">
            <img th:src="@{/img/charge_history_icon.png}" alt="충전이력">
            <span class="label font-m">충전이력</span>
        </div>
        <div class="box charge-status">
            <img th:src="@{/img/charge_status_icon.png}" alt="충전현황">
            <span class="label font-m">충전현황</span>
        </div>
        <div class="box qr" onclick="FlutterBridge.postMessage('openQr'); return false;">
            <img th:src="@{/img/qr_scan_icon.png}" alt="QR 스캔">
            <span class="label font-m">QR 스캔</span>
        </div>
    </div>

    <div class="w-100 mt-3" sec:authorize="isAuthenticated()">
        <div class="fw-bold">당월 충전 내역</div>
        <div class="mt-2 p-3 font-s" style="background-color: #F8F8F8; border-radius: 16px;">
            <div class="row mb-2">
                <div class="col">충전량</div>
                <div class="col text-end"
                    th:text="${chgHist.chgAmount != null ? #numbers.formatDecimal(chgHist.chgAmount, 1, 2) : '0.0'} + 'kWh'"></div>
            </div>
            <div class="row mb-2">
                <div class="col">결제금액</div>
                <div class="col text-end"
                    th:text="${chgHist.realCost != null ? #numbers.formatInteger(chgHist.realCost, 0, 'COMMA') : '0'} + '원'"></div>
            </div>
            <div class="row">
                <div class="col">충전횟수</div>
                <div class="col text-end"
                    th:text="${chgHist.chgCnt != null ? chgHist.chgCnt : '0'} + '회'"></div>
            </div>
        </div>
    </div>

    <div class="position-relative w-100 mt-3" sec:authorize="isAuthenticated()">
        <div class="fw-bold">즐겨찾는 충전소</div>
        <span class="chevron-pos"><i class="bi bi-chevron-right"></i></span>
        <div id="myStation" class="w-100 station-list"></div>
    </div>

    <div class="position-relative w-100 mt-3" id="nearStation">
        <div class="fw-bold">내주변 충전소</div>
        <div id="nearbyStation" class="w-100 station-list"></div>
    </div>

    <div class="position-relative w-100 mt-3" id="notice">
        <div class="fw-bold">공지사항</div>
        <span class="chevron-pos">
            <a th:href="@{/mypage/notice}" class="color-grey"><i class="bi bi-chevron-right"></i></a>
        </span>
        <div class="mt-2">
            <div th:each="notice : ${noticeList}" class="mb-2 font-s">
                <a th:href="@{/mypage/notice/detail/{id}(id=${notice.noticeId})}" class="text-decoration-none">
                    <span th:if="${notice.isNew}" class="new-article">NEW</span>
                    <span th:text="|[${notice.typeName}] ${notice.title}|"></span>
                </a>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/nav :: navFragment}"></div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        console.log('lat: ', lat);
                        console.log('lng: ', lng);

                        fetch(`/nearby/station/top3?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lng)}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error(`HTTP status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then((data) => {
                                console.log(data.csList);
                                const nearbyStation = document.getElementById('nearbyStation');
                                nearbyStation.innerHTML = '';

                                if (!Array.isArray(data.csList) || data.csList.length === 0) {
                                    nearbyStation.innerHTML = `
                                        <div class="station-empty">
                                            주변 충전소 정보를 불러올 수 없습니다.
                                        </div>`;
                                    return;
                                }

                                const html = data.csList.map(cs => `
                                    <div class="station-item" data-id="${cs.stationId}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="font-m">${cs.stationName ?? '이름 없음'}</span>
                                            <span class="font-m text-muted">
                                                <i class="fa-solid fa-route me-2"></i>
                                                ${cs.distance != null ? cs.distance + 'm' : '-'}
                                            </span>
                                        </div>
                                        <div class="font-s text-secondary mt-2">
                                            ${cs.address ?? '주소 정보 없음'}
                                        </div>
                                    </div>
                                `).join('');

                                nearbyStation.innerHTML = html;
                            })
                            .catch((error) => {
                                console.error('Fetch error:', err);
                                const nearbyStation = document.getElementById('nearbyStation');
                                nearbyStation.innerHTML = `
                                    <div class="station-error">
                                        데이터를 불러오는 중 오류가 발생했습니다.
                                    </div>`;
                            });
                    },
                    error => {
                        console.warn("Geolocation error: ",error);
                    }
                );
            } else {
                console.warn("Geolocation is not supported by this browser");
            }
        });
    </script>

    

</div>
</html>